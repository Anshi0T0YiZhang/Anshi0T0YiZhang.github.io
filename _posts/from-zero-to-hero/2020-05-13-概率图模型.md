---
title: "概率图模型"
subtitle: "Probabilistic Graphical Model"
layout: post
author: "echisenyang"
header-style: text
hidden: true
catalog: true
tags:
  - 输出计划
  - 李航统计学习第二版
  - PRML
---



<img src="https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/GSnpMT.jpg" alt="GSnpMT" style="zoom: 25%;" />

<img src="https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/10.隐马尔可夫模型-3.jpg" alt="10.隐马尔可夫模型-3" style="zoom: 25%;" />

<img src="https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/10.隐马尔可夫模型-4.jpg" alt="10.隐马尔可夫模型-4" style="zoom:25%;" />



### 概率图模型介绍

概率图模型是用图来表示变量概率依赖关系的理论，结合概率论与图论的知识，利用图来表示与模型有关的变量的联合概率分布。由图灵奖获得者Pearl开发出来。

- 如果用一个词来形容概率图模型（Probabilistic Graphical Model）的话，那就是“**优雅**”。对于一个实际问题，我们希望能够挖掘隐含在数据中的知识。概率图模型构建了这样一幅图，***用观测结点表示观测到的数据，用隐含结点表示潜在的知识，用边来描述知识与数据的相互关系***，**最后基于这样的关系图获得一个概率分布**，非常“优雅”地解决了问题。

- 概率图中的节点分为隐含节点和观测节点，边分为有向边和无向边。从概率论的角度，***节点对应于随机变量，边对应于随机变量的依赖或相关关系，其中有向边表示单向的依赖，无向边表示相互依赖关系***。



### 有向图模型（贝叶斯网络）

考虑三个变量a, b, c上的⼀个任意的联合分布 $p(a, b, c)$，通过使⽤概率的乘积规则，我们可以将联合概率分布写成下⾯的形式：

$$
\begin{array}{c}p(a, b, c)
&=& p(c  \mid  a, b) p(a, b) \\
&=& p(c  \mid  a, b) p(b  \mid  a) p(a)\end{array}
$$
![04hvJw](https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/04hvJw.png)

另一个

![BceNfF](https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/BceNfF.png)

从图上可以比较直观的看出：

1. 联合概率为：$p\left(x_{1}\right) p\left(x_{2}\right) p\left(x_{3}\right) p\left(x_{4}  \mid  x_{1}, x_{2}, x_{3}\right) p\left(x_{5}  \mid  x_{1}, x_{3}\right) p\left(x_{6}  \mid  x_{4}\right) p\left(x_{7}  \mid  x_{4}, x_{5}\right)$
2. $x_1$ 和 $x_2$ 独立（对应head-to-head）
3. $x_6$ 和 $x_7$ 在 $x_4$ 给定的条件下独立（对应tail-to-tail）

#### 因子分解

在**图的所有结点上定义的联合概率分布**由**每个结点上的条件概率分布的乘积表⽰**，**每个条件概率分布的条件都是图中结点的⽗结点所对应的变量**。因此，对于⼀个有 $K$ 个结点的图，联合概率为

$$
p(\boldsymbol{x})=\prod_{k=1}^{K} p\left(x_{k}  \mid  \mathrm{pa}_{k}\right)
$$

- 其中，${pa}_{k}$ 表⽰ $x_k$ 的⽗结点的集合，$x = \{x_1 , ... , x_K \}$，上式为**有向图模型的联合概率分布的因子分解（factorization）**
- 我们考虑的有向图要满⾜⼀个重要的限制， 即**不能存在有向环**（directed cycle）。这种没有有向环的图被称为**有向⽆环图**（directed acyclic graph），或者**DAG**。

#### **d-划分**

- 模式识别中，使⽤概率模型时，**条件独⽴性**起着重要的作⽤。它简化了模型的结构，降低了模型的训练和推断的计算量。
  - 如果**⼀组变量的联合概率分布的表达式是根据条件概率分布的乘积表⽰**的（即有向图的数学表达形式），那么**原则上**我们可以通过重复使⽤概率的加和规则和乘积规则**测试是否具有潜在的条件独⽴性**。在**实际应⽤**中，这种⽅法⾮常耗时。
  - **图模型的⼀个重要的优雅的特征是，联合概率分布的条件独⽴性可以直接从图中读出来， 不⽤进⾏任何计算**。 完成这件事的⼀般框架被称为“d-划分”（**d-separation**），其中“d”表⽰“有向（directed）”（Pearl, 1988）。

- **完整定义**

  - 我们现在给出有向图D-划分性质的一个一般描述（Pearl, 1988）。考虑一个一般的有向图，其中A,B,C 是任意无交集的结点集合（它们的并集可能比图中结点的完整集合要小）。我们希望弄清楚，一个有向无环图是否暗示了一个特定的条件依赖表述 $A⊥B \mid C$。为了解决这个问题，我们考虑从A中任意结点到B中任意结点的所有可能的路径。我们说这样的路径被“阻隔”，如果它包含一个结点满足下面两个性质中的任何一个。

    1. 路径上的箭头以头到尾或者尾到尾的方式交汇于这个结点，且这个结点在集合C中。
    2. 箭头以头到头的方式交汇于这个结点，且这个结点和它的所有后继都不在集合C中。

    **如果所有的路径都被“阻隔”，那么我们说C把A从B中D-划分开**，且图中所有变量上的联合概率分布将会满足 $A⊥B \mid C$。

结论：⼀个**尾到尾**结点或者**头到尾**结点使得⼀条路径**没有阻隔，除⾮它被观测到，之后它就阻隔了路径**。相反，⼀个**头到头**结点如果**<font color=red>没有被观测到，那么它阻隔了路径，但是⼀旦这个结点或者⾄少⼀个后继被观测到，那么路径就被“解除阻隔”了</font>**。

- **d-划分举例**

![aUawBu](https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/aUawBu.png)

**在图(a)中，从 a 到 b 的路径没有被结点 f 阻隔**，因为对于这个路径来说，它是一个尾到尾结点，并且没有被观测到。**这条路径也没有被结点 e 阻隔**，因为虽然后者是一个头到头的结点，但是它有一个后继c在条件集合中。因此条件独立关系 $a⊥b \mid c$ 在这个图中不成立。

**在图(b)中，从 a 到 b 的路径被结点 f 阻隔**，因为它是一个**尾到尾的结点，并且被观测到**，因此使用这幅图进行分解的任何概率分布都满足条件独立性质 $a⊥b \mid f$。注意，**这个路径也被结点 e 阻隔**，因为 e 是一个头到头的结点，并且它和它的后继都没在条件集合中。

<img src="https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/10.隐马尔可夫模型-5.jpg" alt="10.隐马尔可夫模型-5" style="zoom:25%;" />

<img src="https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/10.隐马尔可夫模型-5.jpg" alt="10.隐马尔可夫模型-5" style="zoom:25%;" />

### 无向图模型（条件随机场）

我们已经看到 **有向图模型表⽰将⼀组变量上的联合概率分布分解为局部条件概率分布的乘积** 的⼀种分解⽅式。**有向图模型也定义了⼀组条件独⽴性质，根据图进⾏分解的任何概率分布都必须满⾜这些条件独⽴性质**。

我们现在考虑图模型的第⼆⼤类，使⽤⽆向图描述的图模型。与之前⼀样，它表⽰⼀个分解⽅式，也表⽰⼀组条件独⽴关系。

![sv8eHu](https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/sv8eHu.png)

#### 条件独⽴性质

- 在有向图的情形下，我们看到可以通过**使⽤被称为d-划分的图检测⽅法判断⼀个特定的条件独⽴性质是否成⽴**。这涉及到判断链接两个结点集合的路径是否被“阻隔”。然⽽，由于**头到头**结点的存在，阻隔的定义多少有些**微妙**。
- 我们可能会问，是否可以**定义另⼀种概率分布的图语义表⽰**，使得条件独⽴性由单⼀的图划分确定。
- 这种情形确实存在，对应于**⽆向图模型。通过移除图中链接的⽅向性，⽗结点和⼦结点的⾮对称性也被移除了，因此头到头结点的微妙性也就不再存在了**。

为了判定由图定义的概率分布是否满⾜这个性质，我们**考虑连接集合 A 的结点和集合 B 的结点的所有可能路径**。如果**所有这些路径都通过了集合 C 中的⼀个或多个结点**，**那么所有这样的路径都被“阻隔”，因此条件独⽴性质成⽴**。然⽽，**如果存在⾄少⼀条未被阻隔的路径**，**那么条件独⽴的性质未必成⽴**，或者更精确地说，存在⾄少某些对应于图的概率分布不满⾜条件独⽴性质。图8.27给出了⼀个例⼦。注意，这与d划分的准则完全相同，唯⼀的差别在于没有头到头的现象。因此，**⽆向图的条件独⽴性的检测⽐有向图简单**。

![5tAR0c](https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/5tAR0c.png)

#### 马尔可夫毯

![5bPKTw](https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/5bPKTw.png)

**我们可以将结点 $x_i$ 的马尔科夫毯想象成将 $x_i$ 与图的剩余部分隔离开的最小结点集合**。注意，只包含 $x_i$ 的**父结点**和**子结点**是不够的，因为之前的例子表明，子结点的观测不会阻隔某个结点到同父结点的路径。因此我们必须也观测**同父结点**。

#### 分解规则（基于最大团的因子分解）

我们现在寻找⽆向图的⼀个分解规则，对应于上述条件独⽴性检测。与之前⼀样，这涉及到**将联合概率分布$p(x)$ 表⽰为在图的局部范围内的变量集合上定义的函数的乘积**。于是，我们需要给出这种情形下，**局部性的⼀个合适定义**。

如果我们考虑两个结点 $x_i$ 和 $x_j$ ，它们不存在链接，那么给定图中的所有其他结点，这两个结点⼀定是条件独⽴的。这是因为**两个结点之间没有直接的路径，并且所有其他的路径都通过了观测的结点，因此这些路径都是被阻隔的**。这个条件独⽴性可以表⽰为

$$
p\left(x_{i}, x_{j}  \mid  \boldsymbol{x}_{\backslash\{i, j\}}\right)=p\left(x_{i}  \mid  \boldsymbol{x}_{\backslash\{i, j\}}\right) p\left(x_{j}  \mid  \boldsymbol{x}_{\backslash i, j\}}\right)
$$

- 其中 $x_{\backslash{i, j}}$ 表⽰**所有变量 x 去掉 $x_i$ 和 $x_j$ 的集合**。于是，联合概率分布的分解**⼀定要让 $x_i$ 和 $x_j$ 不出现在同⼀个因⼦中**，从⽽让属于这个图的所有可能的概率分布都满⾜条件独⽴性质。
- 解决方案就是让 $x_i$ 和 $x_j$ 归属于不同的团块

#### 团、最大团

这将我们引向了⼀个图形的概念，团块（clique）。它被定义为图中结点的⼀个⼦集，使得**在这个⼦集中的每对结点之间都存在链接**。换句话说，**团块中的结点集合是全连接的**。

- 此外，⼀个**最⼤团块**（maximal clique）是具有下⾯性质的团块：
  - **不可能将图中的任何⼀个其他的结点包含到这个团块中⽽不破坏团块的性质**。
  - 图8.29说明了四个变量的⽆向图中的这些概念。这个图中有五个具有两个结点的团块， 即 $ \{x_1, x_2 \}, \{x_2, x_3 \}, \{x_3, x_4 \}, \{x_4, x_2 \}$和 ${x_1, x_3}$，还有两个最⼤团块 $\{x_1, x_2, x_3\}$ 和 $\{x_2 , x_3 , x_4 \}$。集合 ${x_1 , x_2 , x_3 , x_4 }$ 不是⼀个团块，因为在 $x_1$ 和 $x_4$ 没有链接。

![TcaXTB](https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/TcaXTB.png)

于是， 我们可以**将联合概率分布分解的因⼦定义为团块中变量的函数**。 事实上， 我们可以**考虑最⼤团块的函数⽽不失⼀般性**， 因为其他团块⼀定是最⼤团块的⼦集。 因此， 如果 $\{x_1, x_2, x_3\}$ 是⼀个最⼤团块，并我们在这个团块上定义了任意⼀个函数，那么定义在这些变量的⼀个⼦集上的其他因⼦都是冗余的。

- 让我们将团块记作 $C$ ， 将团块中的变量的集合记作 $x_C$ 。 这样，**联合概率分布可以写成图的最⼤团块的势函数**（potential function）$ψ_C (x_C )$ 的乘积的形式

$$
p(\boldsymbol{x})=\frac{1}{Z} \prod_{C} \psi_{C}\left(\boldsymbol{x}_{C}\right)
$$

- **<font color=red>放弃了局部条件概率的概念，转而用“团”的概念来替代表达局部概率</font>**

- 这⾥，$Z$ 有时被称为**划分函数（partition function）**，是⼀个归⼀化常数，等于

$$
Z=\sum_{\boldsymbol{x}} \prod_{C} \psi_{C}\left(\boldsymbol{x}_{C}\right)
$$

⽬前为⽌，我们基于简单的图划分，讨论了条件独⽴性的概念，并且我们**提出了对联合概率分布的分解， 来尝试对应条件独⽴的图结构**。 然⽽， 我**们并没有将条件独⽴性和⽆向图的分解形式化地联系起来**。 为了形式化地描述， 我们需要把注意⼒限制于那些**严格为正的势函数** $ψ_C (x_C )$，即对于任意的 $x_C$ 的选择都永远不等于零也不取负值的势函数。 给定这个限制， 我们可以给出分解和条件独⽴之间的精确关系。

- 转而使用能量函数

#### 能量函数

由于我们的势函数被限制为严格⼤于零，因此将势函数表⽰为指数的形式更⽅便，即

$$
\psi_{C}\left(\boldsymbol{x}_{C}\right)=\exp \left\{-E\left(\boldsymbol{x}_{C}\right)\right\}
$$

- 其中 $E\left(\boldsymbol{x}_{C}\right)$ 被称为**能量函数**（energy function）， **指数表⽰被称为玻尔兹曼分布**（Boltzmann distribution）。**联合概率分布被定义为势函数的乘积**，因此总的能量可以通过将每个最⼤团块的能量相加的⽅法得到。

#### 有向图转为无向图

<img src="https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/nCpM9k.png" alt="nCpM9k" style="zoom:50%;" />

这⾥，**有向图的联合概率分布由⼀组条件概率分布的乘积给出**，形式为

$$
p(\boldsymbol{x})=p\left(x_{1}\right) p\left(x_{2}  \mid  x_{1}\right) p\left(x_{3}  \mid  x_{2}\right) \cdots p\left(x_{N}  \mid  x_{N-1}\right)
$$

现在假设我们将其转化为⽆向图的表⽰⽅法，如图8.32所⽰。在⽆向图中，最⼤团块为相邻结点对，因此根据公式（8.39），我们希望将联合概率分布写成下⾯的形式

$$
p(\boldsymbol{x})=\frac{1}{Z} \psi_{1,2}\left(x_{1}, x_{2}\right) \psi_{2,3}\left(x_{2}, x_{3}\right) \cdots \psi_{N-1, N}\left(x_{N-1}, x_{N}\right)
$$

这很容易做。我们只需令

$$
\begin{array}{c}\psi_{1,2}\left(x_{1}, x_{2}\right)=p\left(x_{1}\right) p\left(x_{2}  \mid  x_{1}\right) \\ \psi_{2,3}\left(x_{2}, x_{3}\right)=p\left(x_{3}  \mid  x_{2}\right) \\ \vdots \\ \psi_{N-1, N}\left(x_{N-1}, x_{N}\right)=p\left(x_{N}  \mid  x_{N-1}\right)\end{array}
$$

其中将第⼀个结点的边缘概率分布 $p(x_1)$ 放到了第⼀个势函数中。注意，在这种情况下，划分函数为 $Z = 1$。

#### 道德图

让我们考虑如何推⼴这个结构，使得我们**可以将任意由有向图的分解给出的概率分布转化为⽤⽆向图的分解表⽰的概率分布**。

- 如果⽆向图的团块势函数由有向图的条件概率分布给出，那 么这个任务就可以完成。为了保持这个过程的合法性，我们**必须确保出现在每个条件概率分布中的变量的集合是⽆向图中⾄少⼀个团块的成员**。
  - 对于有向图中**只有⼀个⽗结点的结点**，可以通过简单地将有向链接替换为⽆向链接的⽅式完成。
  - 然⽽，对于有向图中**具有多个⽗结点的结点**来说，这样做是不够的。这些结点是我们在讨论条件独⽴性时遇到的“**头到头**”路径的结点。 考虑图8.33所⽰的具有4个结点的简单有向图。有向图的联合概率分布为 $p(x) = p(x 1 )p(x 2 )p(x 3 )p(x 4  \mid  x 1 x 2 x 3 )$

<img src="https://gitee.com/echisenyang/GiteeForUpicUse/raw/master/uPic/CAzbdW.png" alt="CAzbdW" style="zoom:50%;" />

- 道德图就是用来**把有向图转为无向图**



